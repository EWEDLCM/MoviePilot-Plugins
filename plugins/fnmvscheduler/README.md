# 飞牛影视调度器 (Fnmvscheduler)

**版本:** 1.2.2  
**作者:** EWEDL

## 📖 简介

当使用 MoviePilot 自动整理影视内容到飞牛(Trime)媒体服务器时，如何智能、高效地触发媒体库扫描是一个常见痛点。频繁的扫描会占用系统资源，而扫描不及时又会导致新入库的媒体无法立即观看。

**飞牛影视调度器** 是一款为 MoviePilot 设计的增强插件，它通过监听文件转移完成事件，专门为飞牛（Trime）媒体服务器提供高度智能化的媒体库扫描调度功能。它能有效避免不必要的重复扫描，确保在最佳时机刷新媒体库，尤其为使用云盘挂载的用户提供了精细化的控制逻辑。

## ✨ 核心功能

*   **事件驱动**：自动监听 MoviePilot 的“转移完成”事件，无需手动操作。
*   **路径精准匹配**：自动将转移的目标路径与飞牛媒体服务器中配置的媒体库路径进行匹配。
*   **两种扫描模式**：
    *   **本地模式**：适用于本地硬盘或NAS，文件入库后立即触发扫描，简单高效。
    *   **网盘模式**：专为云盘挂载优化，包含防抖、任务冲突检测、重试与静默等待等高级逻辑，最大化提升扫描成功率和效率。
*   **任务冲突感知**：在触发扫描前，会主动检查飞牛服务器上是否已有扫描任务在运行，避免冲突。
*   **辅助调试工具**：提供“记录媒体库”和“扫描任务检测”功能，方便用户快速排查配置问题。
*   **多服务器支持**：可以灵活选择对哪些已配置的飞牛媒体服务器生效。

## ⚙️ 安装

1.  进入 MoviePilot 的插件市场。
2.  找到 “飞牛影视调度器”。
3.  点击安装。

## 🛠️ 配置指南

在插件市场中找到已安装的“飞牛影视调度器”，点击进入配置页面。

| 配置项 | 说明 |
| :--- | :--- |
| **启用插件** | 总开关，勾选后插件才会开始工作。 |
| **网盘模式** | **核心功能开关**。<br>- **不勾选（本地模式）**：当文件转移到本地或NAS路径匹配的媒体库后，**立即**触发扫描。<br>- **勾选（网盘模式）**：当文件转移到云盘路径 (`/vol0` 开头) 匹配的媒体库后，将启动一套**智能调度逻辑**（详见下文）。 |
| **记录媒体库** | 这是一个**一次性**的调试功能。<br>勾选并保存后，插件会立即在 MoviePilot 的日志中详细打印出所有已配置媒体服务器的媒体库信息（ID、名称、路径等）。这对于检查媒体库路径是否配置正确非常有用。任务执行后，此开关会自动关闭。 |
| **扫描任务检测** | 这是另一个**一次性**的调试功能。<br>勾选并保存后，插件会立即检查所有已配置的飞牛服务器，并在日志中打印当前正在运行的扫描任务。这可以用来确认插件是否能正常与飞牛服务器通信。任务执行后，此开关会自动关闭。 |
| **选择媒体服务器** | 默认情况下，插件会对所有已配置的飞牛服务器生效。<br>如果您只想让本插件管理特定的几个飞牛服务器，请在此处选择。如果留空，则处理所有服务器。 |

## ❗重要说明
使用本项目，需要确保MP在映射媒体库时采用与飞牛影视一致的全路径映射，例如：
```
volumes:
  - '/vol2/1000/download:/vol2/1000/download'
  - '/vol02/1000-1-7e0881d7:/vol02/1000-1-7e0881d7' 
```
否则无法正常匹配媒体库

## 🧠 工作逻辑详解

### 本地模式 (Local Mode)

此模式逻辑非常直接：

1.  MoviePilot 完成文件转移。
2.  插件监听到事件，并匹配到媒体库路径。
3.  插件判断该路径**不是**网盘路径。
4.  插件**立即**向飞牛服务器发送该媒体库的扫描请求。

**适用场景**：您的媒体文件存储在本地硬盘、SSD 或响应迅速的局域网 NAS 上。

### 网盘模式 (Cloud Drive Mode)

此模式专为云盘（如通过 `rclone` 挂载的阿里云盘等）设计，因为云盘的文件同步可能存在延迟，且批量转移文件时会触发大量事件。
如果你通过smb、webdav等协议挂载的是内网设备，则没必要打开该模式。

流程如下：

1.  **启动与防抖 (5分钟)**
    *   当第一个文件转移完成事件到达时，针对该媒体库启动一个 **5分钟的防抖计时器**。
    *   如果在5分钟内，**同一个媒体库**又有新的文件转移事件到达，则重置此计时器。
    *   目的：将短时间内密集的转移操作合并为一次扫描请求。

2.  **首次任务检查**
    *   5分钟防抖计时器结束后，插件会**立即检查**飞牛服务器，看这个媒体库当前是否**已经在扫描中**。

3.  **决策分支**
    *   **情况A：媒体库空闲**
        *   如果检查发现没有正在运行的扫描任务，插件会**立即触发一次新的扫描**。本轮调度结束。
    *   **情况B：媒体库正忙**
        *   如果检查发现该媒体库已在扫描中，插件会进入“等待与重试”循环。

4.  **等待与重试循环 (每3分钟一次)**
    *   插件会等待 **3分钟**。
    *   3分钟后，再次检查任务状态。如果任务仍未结束，则再等3分钟，如此往复。

5.  **静默等待期 (10分钟)**
    *   当“等待与重试”循环最终确认之前的扫描任务**已经完成**后，插件并不会马上扫描，而是会进入一个 **10分钟的静默等待期**。
    *   目的：为云盘的缓存同步、文件校验等后台操作预留充足的时间，确保文件“尘埃落定”，提高扫描成功率。

6.  **最终扫描**
    *   10分钟静默期结束后，插件会**最终触发一次新的扫描**。本轮调度结束。

7.  **核心中断逻辑**
    *   如果在**步骤4（3分钟重试等待）**或**步骤5（10分钟静默等待）**期间，又有一个**新的文件转移事件**属于同一个媒体库，那么当前的等待会被**立即中止**，整个流程将**直接跳回到步骤1**，重新开始一个全新的5分钟防抖计时。

## ❓ 常见问题 (FAQ)

**Q: 插件启用了，但为什么文件转移后没有触发扫描？**  
**A:** 请检查以下几点：
1.  **路径匹配**：插件的匹配逻辑是：`转移目标目录 -> 父目录(剧集名) -> 父目录(分类)`。这个“分类”目录必须和您在飞牛媒体库中设置的路径**完全一致**。
2.  **日志信息**：查看 MoviePilot 的日志，搜索关键词“飞牛影视调度器”，确认插件是否接收到了事件并打印了匹配成功或失败的信息。
3.  **模式选择**：确认您的路径类型（本地 vs. 网盘）是否与插件设置的模式匹配。例如，网盘路径（`/vol0/...`）需要勾选“网盘模式”才能生效。
4.  **服务器选择**：如果您在配置中选择了特定的媒体服务器，请确保该媒体库属于被选中的服务器。

**Q: 如何确认我的媒体库路径是否正确？**  
**A:** 使用插件配置中的“记录媒体库”功能。勾选保存后，去日志里查看插件打印出的路径，和你认为的路径做比对。

## 📜 更新日志

*   **v1.2.2 (2025-08-19)**
    *   **变更:** 插件正式更名为 `Fnmvscheduler` (飞牛影视调度器)。
    *   **变更:** 更新所有日志输出，使其更具辨识度。
*   **v1.2.0 (2025-08-19)**
    *   **重构:** 全面重构“网盘模式”下的智能调度逻辑，引入防抖、重试、静默等待和中断机制。
*   **v1.1.3 (初始版本)**
    *   实现基本的事件监听和扫描触发功能。
