# 飞牛影视调度器 (Fnmvscheduler)

**版本:** 2.2.0
**作者:** EWEDL

## 📖 简介

**飞牛影视调度器** 是一款为 MoviePilot 设计的增强插件，它通过监听文件转移完成事件，专门为飞牛（Fnos）媒体服务器提供高度智能化的媒体库扫描调度功能。它能有效避免不必要的重复扫描，确保在最佳时机刷新媒体库，尤其为使用云盘挂载的用户提供了精细化的控制逻辑。

## ✨ 核心功能

*   **事件驱动**：自动监听 MoviePilot 的"转移完成"事件，无需手动操作。
*   **路径精准匹配**：支持自定义扫描规则，自动将转移的目标路径与飞牛媒体服务器中配置的媒体库路径进行匹配。
*   **三种扫描模式**：
    *   **本地模式**：适用于本地硬盘或NAS，文件入库后立即触发扫描，简单高效。（飞牛的本地扫描已经足够灵敏，但在媒体路径为挂载路径时会默认走网盘策略。该模式主要解决在影视服务器中引用smb等本地挂载时扫描不够迅速）
    *   **网盘模式**：专为云盘挂载优化，包含防抖、任务冲突检测、重试与静默等待等高级逻辑，最大化提升扫描成功率和效率。
    *   **精确扫描**：🆕 指定文件夹扫描，大幅缩短入库时间，需在mp的docker中添加路径映射。建议网盘挂载到飞牛后映射进mp，而非mp中直接添加网盘。
*   **任务冲突感知**：在触发扫描前，会主动检查飞牛服务器上是否已有扫描任务在运行，避免冲突。
*   **智能Token管理**：🆕 内置Token缓存机制，30分钟内复用登录状态，大幅减少重复登录请求，提升响应速度。
*   **日志管理**：支持自动和手动日志清理，支持自定义Cron表达式定时清理。
*   **辅助调试工具**：提供"媒体库获取测试"和"扫描任务检测"功能，方便用户快速排查配置问题。
*   **多服务器支持**：可以灵活选择对哪些已配置的飞牛媒体服务器生效。

## ⚙️ 安装

1.  进入 MoviePilot 的插件市场，添加本gitub仓库。
2.  找到 "飞牛影视调度器"。
3.  点击安装。

## 🛠️ 配置指南

在我的插件中找到已安装的"飞牛影视调度器"，点击进入配置页面。

### 基础设置标签

| 配置项 | 说明 |
| :--- | :--- |
| **启用插件** | 总开关，勾选后插件才会开始工作。 |
| **扫描规则** | 🆕 **核心配置**。定义路径与媒体库的映射关系，每行一条规则，格式：<br>`整理后路径#媒体库名称#模式`<br>模式可选：`本地` 或 `网盘`<br>示例：<br>`/volume1/media/电视剧#电视剧#本地`<br>`/vol2/1000/download#电影#网盘` |
| **选择媒体服务器** | 默认情况下，插件会对所有已配置的飞牛服务器生效。<br>如果您只想让本插件管理特定的几个飞牛服务器，请在此处选择。如果留空，则处理所有服务器。 |

### 维护标签

#### 测试功能
| 配置项 | 说明 |
| :--- | :--- |
| **媒体库获取测试** | **一次性**调试功能。勾选并保存后，插件会立即在日志中打印所有已配置媒体服务器的媒体库信息（ID、名称、路径等）。任务执行后，此开关会自动关闭。 |
| **获取扫描队列测试** | **一次性**调试功能。勾选并保存后，插件会检查所有飞牛服务器当前正在运行的扫描任务。任务执行后，此开关会自动关闭。 |

#### 日志管理
| 配置项 | 说明 |
| :--- | :--- |
| **自动清除日志** | 启用后，插件会按照设定的Cron表达式自动清理日志文件。 |
| **清除日志（单次）** | **一次性**功能。勾选并保存后，立即清空所有插件相关的日志文件。任务执行后，此开关会自动关闭。 |
| **自动清除日志Cron表达式** | 设置自动清理日志的时间规则，默认为每周一早上8点（`0 8 * * 1`）。支持五位Cron表达式。 |

### 高级标签

#### 精确扫描设置
| 配置项 | 说明 |
| :--- | :--- |
| **精确扫描** | 🆕 **高级功能开关**。启用后将使用指定文件夹扫描模式，大幅缩短入库时间。|
| **开启通知** | 🆕 精确扫描结果通知开关。启用后，当有路径扫描失败时会发送通知消息。 |
| **通知渠道** | 🆕 选择精确扫描结果的通知渠道。支持MoviePilot平台的所有通知方式。 |

## ❗重要说明

### 路径映射要求
使用本项目，需要确保MP在映射媒体库时采用与飞牛影视一致的全路径映射，例如：
```
volumes:
  - '/vol2/1000/download:/vol2/1000/download'
  - '/vol02/1000-1-7e0881d7:/vol02/1000-1-7e0881d7'
```
否则无法正常匹配媒体库

### 精确扫描模式要求
🆕 如需使用精确扫描功能，需要在Docker中添加以下路径映射：
```
volumes:
  - '/usr/local/apps/@appdata/trim.media/logs/trim-media.log:/trim-media/trim-media.log'
```


## ❓ 常见问题 (FAQ)

**Q: 插件启用了，但为什么文件转移后没有触发扫描？**
**A:** 请检查以下几点：
1.  **扫描规则配置**：确认已在"扫描规则"中正确配置路径映射规则，格式为 `路径#媒体库名称#模式`。
2.  **路径匹配**：插件会提取文件路径的剧集目录进行匹配。确保您的规则路径与实际文件路径匹配。
4.  **模式选择**：确认您在扫描规则中设置的模式（本地 vs. 网盘）是否符合实际情况。
5.  **服务器选择**：如果您在配置中选择了特定的媒体服务器，请确保该媒体库属于被选中的服务器。
6.  **精确扫描要求**：如果启用了精确扫描，将无本地/网盘区别，采用同一套处理逻辑，请确认Docker路径映射是否正确配置。建议网盘挂载到飞牛后映射进mp，而非mp中直接添加网盘。

**Q: 如何确认我的媒体库路径是否正确？**
**A:** 使用插件配置中的"媒体库获取测试"功能。勾选保存后，去日志里查看插件打印出的所有媒体库信息。

**Q: 精确扫描不工作怎么办？**
**A:** 请检查：
1. 确认已启用"精确扫描"开关
2. 确认Docker中是否正确添加了trim-media.log的路径映射
3. 查看日志确认是否成功读取到日志文件和签名信息
4. 如果无法读取日志文件，插件会自动回退到常规扫描模式

**Q: 如何配置自动日志清理？**
**A:**
1. 启用"自动清除日志"开关
2. 设置合适的Cron表达式（默认为每周一早上8点：`0 8 * * 1`）
3. 插件会自动清理主日志文件和备份文件

**Q: 精确扫描失败时如何处理？**
**A:**
1. 精确扫描失败时，插件会记录失败路径的详细信息
2. **🆕 如果启用了通知功能**，会自动发送通知消息
3. 通知格式简洁，只列出失败的路径序号和名称
4. 精确扫描模式不回退到常规扫描模式


## 📜 更新日志

### v2.2.0 
*   🗑️ **自动日志清理**: 新增精确扫描成功后自动清理trim-media.log功能
*   📏 **智能大小检测**: 当日志文件超过5MB时进行清理，防止log文件过大被整理，导致映射失效。
*   🔧 **配置优化**: 修复配置界面显示问题，优化高级设置布局

### v2.1.5
*   🔄 **等待逻辑优化**: 任务冲突时改为继续等待，每30秒检测一次，直到任务完成
*   🎯 **签名错误判断**: 新增签名错误判断
*   📱 **通知系统**: 新增精确扫描失败通知功能，支持自选通知渠道
*   🔧 **配置优化**: 添加通知开关和通知渠道选择配置
*   📝 **文档更新**: 完善使用说明和常见问题解答

### v2.1.4 
*   🚀 **性能优化**: 新增智能Token缓存机制，30分钟内复用登录状态，大幅减少重复登录请求
*   🔧 **代码重构**: 统一Token管理，优化登录逻辑，提升代码维护性
*   📝 **文档更新**: 完善配置说明和工作逻辑文档

### v2.1.3 
*   🗑️ **功能清理**: 移除单文件夹扫描测试和authx存活测试功能
*   🧹 **代码优化**: 清理冗余代码，提升代码质量

### v2.1.2 
*   🎯 **精确扫描优化**: 实现路径收集和去重机制，支持同一媒体库多路径处理
*   🔄 **串行处理**: 优化精确扫描逻辑，避免"Task duplicate"错误
*   ⏱️ **智能等待**: 添加30秒缓冲时间，确保任务间不冲突
*   📊 **状态监控**: 增强任务状态检查和等待机制

### v2.1.1
*   🎯 **精确扫描模式**: 全新高级功能，支持指定文件夹扫描
*   🔑 **智能签名管理**: 动态生成和管理API签名，确保扫描成功率
*   📁 **路径映射**: 新增trim-media.log路径映射要求
*   🛠️ **配置优化**: 重新设计配置界面，增加高级功能选项

### v2.0.6
*   📋 **扫描规则重构**: 支持自定义扫描规则，替代原有的路径匹配逻辑
*   🗓️ **日志管理**: 新增自动和手动日志清理功能，支持Cron表达式
*   🏗️ **架构升级**: 全面重构插件架构，提升稳定性和扩展性

### v1.5.1
*   **变更:** 优化日志和代码结构

### v1.2.2 
*   **变更:** 插件正式更名为 `Fnmvscheduler` (飞牛影视调度器)
*   **变更:** 更新所有日志输出，使其更具辨识度

### v1.2.0
*   **重构:** 全面重构"网盘模式"下的智能调度逻辑，引入防抖、重试、静默等待和中断机制

### v1.1.3 
*   实现基本的事件监听和扫描触发功能
